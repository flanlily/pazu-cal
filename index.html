function runDamageCalculation() {
    const selectedDungeon = dungeonSelect.value;
    const selectedFloor = floorSelect.value;
    const valA = parseFloat(inputA.value);
    const valB = parseFloat(inputB.value);
    const valC = parseFloat(inputC.value);
    const valL = parseInt(inputL.value) || 0;
    const valAttr = parseInt(inputAttr.value) || 0;

    resultsTableBody.innerHTML = ''; // ← 先にテーブルクリア

    if (!selectedDungeon || !selectedFloor) {
        totalReductionRateDisplay.textContent = '';
        // 計算前：元の割合をそのまま出力
        if (selectedDungeon && selectedFloor && damageDungeonData[selectedDungeon]?.[selectedFloor]) {
            const damageRatios = damageDungeonData[selectedDungeon][selectedFloor];
            damageRatios.forEach(ratio => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${ratio}%</td>
                    <td>${ratio}%</td>
                    <td>-</td>
                `;
                resultsTableBody.appendChild(tr);
            });
        }
        return;
    }

    if (isNaN(valA) || isNaN(valB)) {
        totalReductionRateDisplay.textContent = 'リーダー軽減率と助っ人軽減率は数値で入力してください。';
        return;
    }

    if (valL < 0 || valAttr < 0) {
        totalReductionRateDisplay.textContent = '個数は0以上で入力してください。';
        return;
    }

    // 軽減率計算
    const leaderReduce = 1 - valA;
    const friendReduce = 1 - valB;
    const skillReduce = 1 - valC;
    const lReduce = 1 - 0.05 * valL;
    const attrReduce = 1 - 0.025 * valAttr;

    let totalReduce = leaderReduce * friendReduce * skillReduce * lReduce * attrReduce;
    totalReduce = Math.max(0, Math.min(1, totalReduce)); // 0〜1に制限
    const totalReducePercent = ((1 - totalReduce) * 100).toFixed(2);
    totalReductionRateDisplay.textContent = `総軽減率: ${totalReducePercent}%`;

    // ダメージ軽減後のダメージを表示
    const damageRatios = damageDungeonData[selectedDungeon][selectedFloor];

    damageRatios.forEach(ratio => {
        const finalDamagePercent = (ratio * (1 - totalReduce)).toFixed(2);
        const canSurvive = finalDamagePercent < 100 ? '耐えられる' : '耐えられない';

        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${ratio}%</td>
            <td>${finalDamagePercent}%</td>
            <td class="${canSurvive === '耐えられる' ? 'can-withstand' : 'cannot-withstand'}">${canSurvive}</td>
        `;
        resultsTableBody.appendChild(tr);
    });
}
