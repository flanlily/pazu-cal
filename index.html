<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="style.css" />
    <title>PDC非対応計算ツール</title>
</head>

<body>
    <div class="container">
        <h1>PDC非対応計算ツール</h1>

        <!-- タブボタン -->
        <div class="tabs">
            <button class="tab-button active" data-tab="damage">現在HP割合計算</button>
            <button class="tab-button" data-tab="exp">経験値計算</button>
        </div>

        <!-- ダメージ軽減タブコンテンツ -->
        <div id="damage" class="tab-content">
            <div class="input-group">
                <label for="dungeonSelect">ダンジョン選択:</label>
                <select id="dungeonSelect"></select>
            </div>

            <div class="input-group">
                <label for="floorSelect">フロア選択:</label>
                <select id="floorSelect"></select>
            </div>

            <div class="input-group">
                <label for="inputA">リーダー軽減率 (A) 0〜1の小数で入力</label>
                <input type="number" id="inputA" min="0" max="1" step="0.01" value="0" />
            </div>

            <div class="input-group">
                <label for="inputB">助っ人軽減率 (B) 0〜1の小数で入力</label>
                <input type="number" id="inputB" min="0" max="1" step="0.01" value="0" />
            </div>

            <div class="input-group">
                <label for="inputC">軽減スキル (C)</label>
                <select id="inputC">
                    <option value="0">0%</option>
                    <option value="0.3">30%</option>
                    <option value="0.35">35%</option>
                    <option value="0.4">40%</option>
                    <option value="0.5">50%</option>
                    <option value="0.6">60%</option>
                    <option value="0.7">70%</option>
                    <option value="0.75">75%</option>
                    <option value="0.8">80%</option>
                    <option value="0.9">90%</option>
                    <option value="1">100% (完全無効)</option>
                </select>
            </div>

            <div class="input-group">
                <label for="inputL">回復L字消し個数 (1個5%軽減)</label>
                <input type="number" id="inputL" min="0" step="1" value="0" />
            </div>

            <div class="input-group">
                <label for="inputAttr">属性軽減+個数 (1個2.5%軽減)</label>
                <input type="number" id="inputAttr" min="0" step="1" value="0" />
            </div>

            <div id="results">
                <h2>計算結果</h2>
                <p id="totalReductionRate"></p>
                <table class="results-table" id="resultsTable">
                    <thead>
                        <tr>
                            <th>フロアの割合ダメージ</th>
                            <th>最終的なHPに対するダメージ割合</th>
                            <th>耐えれるか</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- 経験値タブコンテンツ -->
        <div id="exp" class="tab-content hidden">
            <h2>経験値計算</h2>

            <div class="input-group">
                <label for="expDungeon">ダンジョン選択:</label>
                <select id="expDungeon"></select>
            </div>

            <div class="input-group">
                <label for="expFloor">フロア選択:</label>
                <select id="expFloor" disabled></select>
            </div>

            <div class="input-group">
                <label for="leaderMultiplier">リーダー経験値倍率:</label>
                <select id="leaderMultiplier">
                    <option value="1.0">1.0倍</option>
                    <option value="1.1">1.1倍</option>
                    <option value="1.2">1.2倍</option>
                    <option value="1.3">1.3倍</option>
                    <option value="1.4">1.4倍</option>
                    <option value="1.5">1.5倍</option>
                    <option value="1.6">1.6倍</option>
                    <option value="1.7">1.7倍</option>
                    <option value="1.8">1.8倍</option>
                    <option value="1.9">1.9倍</option>
                    <option value="2.0">2.0倍</option>
                </select>
            </div>

            <div class="input-group">
                <label for="friendMultiplier">助っ人経験値倍率:</label>
                <select id="friendMultiplier">
                    <option value="1.0">1.0倍</option>
                    <option value="1.1">1.1倍</option>
                    <option value="1.2">1.2倍</option>
                    <option value="1.3">1.3倍</option>
                    <option value="1.4">1.4倍</option>
                    <option value="1.5">1.5倍</option>
                    <option value="1.6">1.6倍</option>
                    <option value="1.7">1.7倍</option>
                    <option value="1.8">1.8倍</option>
                    <option value="1.9">1.9倍</option>
                    <option value="2.0">2.0倍</option>
                </select>
            </div>

            <div class="input-group">
                <label for="dungeonBonusCount">ダンジョンボーナス覚醒数:</label>
                <input type="number" id="dungeonBonusCount" min="0" step="1" value="0" />
                <small>1つにつき2%加算され、累乗されます</small>
            </div>

            <div id="expResult">
                <h2>経験値結果</h2>
                <p id="expValue">-</p>
            </div>
        </div>
    </div>

    <script>
        // ----------- データ読み込み関連 -----------
        async function fetchDamageDungeonData() {
            const response = await fetch('./dungeonData.json');
            if (!response.ok) {
                alert('ダメージダンジョンデータの読み込みに失敗しました。');
                return {};
            }
            const data = await response.json();
            for (const dungeon in data) {
                for (const floor in data[dungeon]) {
                    if (typeof data[dungeon][floor] === 'string') {
                        data[dungeon][floor] = data[dungeon][floor]
                            .split(',')
                            .map(s => parseFloat(s.replace('%', '').trim()))
                            .filter(v => !isNaN(v));
                    }
                }
            }
            return data;
        }

        async function fetchExpData() {
            const response = await fetch('./pad_experience_data.json');
            if (!response.ok) {
                alert('経験値データの読み込みに失敗しました。');
                return {};
            }
            const data = await response.json();
            return data;
        }

        // ----------- HTML要素 -----------
        const dungeonSelect = document.getElementById('dungeonSelect');
        const floorSelect = document.getElementById('floorSelect');
        const inputA = document.getElementById('inputA');
        const inputB = document.getElementById('inputB');
        const inputC = document.getElementById('inputC');
        const inputL = document.getElementById('inputL');
        const inputAttr = document.getElementById('inputAttr');
        const totalReductionRateDisplay = document.getElementById('totalReductionRate');
        const resultsTableBody = document.querySelector('#resultsTable tbody');

        const expDungeon = document.getElementById('expDungeon');
        const expFloor = document.getElementById('expFloor');
        const leaderMultiplier = document.getElementById('leaderMultiplier');
        const friendMultiplier = document.getElementById('friendMultiplier');
        const dungeonBonusCount = document.getElementById('dungeonBonusCount');
        const expValueDisplay = document.getElementById('expValue');

        const tabs = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');

        let damageDungeonData = {};
        let expData = {};

        // ----------- タブ切り替え処理 -----------
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');

                tabContents.forEach(tc => {
                    if (tc.id === tab.dataset.tab) {
                        tc.classList.remove('hidden');
                    } else {
                        tc.classList.add('hidden');
                    }
                });
            });
        });

        // ----------- ダメージ軽減処理 -----------
        function initializeDamageDungeonSelect() {
            dungeonSelect.innerHTML = '<option value="">ダンジョンを選択してください</option>';
            for (const dungeonName in damageDungeonData) {
                const option = document.createElement('option');
                option.value = dungeonName;
                option.textContent = dungeonName;
                dungeonSelect.appendChild(option);
            }
            floorSelect.innerHTML = '<option value="">フロアを選択してください</option>';
            floorSelect.disabled = true;
        }

        dungeonSelect.addEventListener('change', () => {
            const selectedDungeon = dungeonSelect.value;
            floorSelect.innerHTML = '<option value="">フロアを選択してください</option>';
            floorSelect.disabled = true;

            if (selectedDungeon && damageDungeonData[selectedDungeon]) {
                const floors = damageDungeonData[selectedDungeon];
                for (const floorName in floors) {
                    const option = document.createElement('option');
                    option.value = floorName;
                    option.textContent = floorName;
                    floorSelect.appendChild(option);
                }
                floorSelect.disabled = false;
            }
            runDamageCalculation();
        });

        floorSelect.addEventListener('change', runDamageCalculation);
        [inputA, inputB, inputC, inputL, inputAttr].forEach(el => {
            el.addEventListener('input', runDamageCalculation);
            el.addEventListener('change', runDamageCalculation);
        });

        function runDamageCalculation() {
            const selectedDungeon = dungeonSelect.value;
            const selectedFloor = floorSelect.value;
            const valA = parseFloat(inputA.value);
            const valB = parseFloat(inputB.value);
            const valC = parseFloat(inputC.value);
            const valL = parseInt(inputL.value) || 0;
            const valAttr = parseInt(inputAttr.value) || 0;

            if (!selectedDungeon || !selectedFloor) {
                totalReductionRateDisplay.textContent = '';
                resultsTableBody.innerHTML = '';
                return;
            }
            if (isNaN(valA) || isNaN(valB)) {
                totalReductionRateDisplay.textContent = 'リーダー軽減率と助っ人軽減率は数値で入力してください。';
                resultsTableBody.innerHTML = '';
                return;
            }
            if (valL < 0 || valAttr < 0) {
                totalReductionRateDisplay.textContent = '個数は0以上で入力してください。';
                resultsTableBody.innerHTML = '';
                return;
            }

            // 軽減率計算
            // (1 - A) * (1 - B) * (1 - C) * (1 - 0.05 * L) * (1 - 0.025 * attr)
            const leaderReduce = 1 - valA;
            const friendReduce = 1 - valB;
            const skillReduce = 1 - valC;
            const lReduce = 1 - 0.05 * valL;
            const attrReduce = 1 - 0.025 * valAttr;

            let totalReduce = leaderReduce * friendReduce * skillReduce * lReduce * attrReduce;
            totalReduce = Math.max(0, Math.min(1, totalReduce)); // 0〜1に制限

            const totalReducePercent = ((1 - totalReduce) * 100).toFixed(2);

            totalReductionRateDisplay.textContent = `総軽減率: ${totalReducePercent}%`;

            // フロアの割合ダメージごとに最終ダメージを計算し表示
            const damageRatios = damageDungeonData[selectedDungeon][selectedFloor];

            resultsTableBody.innerHTML = '';

            damageRatios.forEach(ratio => {
                const finalDamage = ratio / 100 * totalReduce; // 0〜1の割合
                const finalDamagePercent = (finalDamage * 100).toFixed(2) + '%';

                const canWithstand = finalDamage <= 1; // HP1として耐えられるか

                const tr = document.createElement('tr');
                const tdRatio = document.createElement('td');
                tdRatio.textContent = ratio + '%';

                const tdFinal = document.createElement('td');
                tdFinal.textContent = finalDamagePercent;

                const tdCan = document.createElement('td');
                tdCan.textContent = canWithstand ? '耐えられる' : '耐えられない';
                tdCan.className = canWithstand ? 'can-withstand' : 'cannot-withstand';

                tr.appendChild(tdRatio);
                tr.appendChild(tdFinal);
                tr.appendChild(tdCan);

                resultsTableBody.appendChild(tr);
            });
        }

        // ----------- 経験値計算処理 -----------
        function initializeExpDungeonSelect() {
            expDungeon.innerHTML = '<option value="">ダンジョンを選択してください</option>';
            expFloor.innerHTML = '<option value="">フロアを選択してください</option>';
            expFloor.disabled = true;

            for (const dungeon in expData) {
                const option = document.createElement('option');
                option.value = dungeon;
                option.textContent = dungeon;
                expDungeon.appendChild(option);
            }
        }

        expDungeon.addEventListener('change', () => {
            const selectedDungeon = expDungeon.value;
            expFloor.innerHTML = '<option value="">フロアを選択してください</option>';
            expFloor.disabled = true;
            expValueDisplay.textContent = '-';

            if (selectedDungeon && expData[selectedDungeon]) {
                const floors = expData[selectedDungeon];
                for (const floor in floors) {
                    const option = document.createElement('option');
                    option.value = floor;
                    option.textContent = floor;
                    expFloor.appendChild(option);
                }
                expFloor.disabled = false;
            }
            calculateExp();
        });

        expFloor.addEventListener('change', calculateExp);
        leaderMultiplier.addEventListener('input', calculateExp);
        friendMultiplier.addEventListener('input', calculateExp);
        dungeonBonusCount.addEventListener('input', calculateExp);

        function calculateExp() {
            const dungeon = expDungeon.value;
            const floor = expFloor.value;

            let leaderMul = parseFloat(leaderMultiplier.value);
            if (isNaN(leaderMul) || leaderMul < 1) leaderMul = 1.0;

            let friendMul = parseFloat(friendMultiplier.value);
            if (isNaN(friendMul) || friendMul < 1) friendMul = 1.0;

            const bonusCount = parseInt(dungeonBonusCount.value) || 0;

            if (!dungeon || !floor) {
                expValueDisplay.textContent = '-';
                return;
            }

            let baseExp;

            // expData[dungeon][floor] は経験値数値か、配列の場合もある想定
            if (Array.isArray(expData[dungeon][floor])) {
                baseExp = expData[dungeon][floor].reduce((a, b) => a + b, 0);
            } else if (typeof expData[dungeon][floor] === 'number') {
                baseExp = expData[dungeon][floor];
            } else {
                baseExp = 0;
            }

            // ダンジョンボーナス覚醒は1つにつき2%加算されて乗算
            const bonusMultiplier = Math.pow(1.02, bonusCount);

            let expResult = Math.floor(baseExp * leaderMul * friendMul * bonusMultiplier);

            expValueDisplay.textContent = `経験値: ${expResult.toLocaleString()}（ベース: ${baseExp.toLocaleString()}）`;
        }

        // ----------- 初期化処理 -----------
        async function initialize() {
            damageDungeonData = await fetchDamageDungeonData();
            initializeDamageDungeonSelect();

            expData = await fetchExpData();
            initializeExpDungeonSelect();

            runDamageCalculation();
            calculateExp();
        }

        window.addEventListener('DOMContentLoaded', initialize);
    </script>
</body>

</html>
