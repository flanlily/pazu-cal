<!DOCTYPE html>
<html lang="ja">

    <head>
        <meta charset="utf-8" />
        <meta content="width=device-width, initial-scale=1" name="viewport" />
        <link href="style.css" rel="stylesheet" />
        <title>PDCéå¯¾å¿œè¨ˆç®—ãƒ„ãƒ¼ãƒ«</title>
        <link href="./manifest.json" rel="manifest" />
        <meta content="#0078d7" name="theme-color" />
    </head>

    <body>
        <div class="notification-sync-bar">
            <div class="notification-icon" id="notificationIcon">
                <span class="notification-badge hidden" id="notificationBadge"></span>
            </div>
            <button id="syncButton">ğŸ”„ ãƒ‡ãƒ¼ã‚¿åŒæœŸ</button>
        </div>
            <span class="notification-badge hidden" id="notificationBadge"></span>
        </div>

        <div class="popup-wrapper hidden" id="notificationPopup">
            <div class="popup-overlay" id="popupOverlay"></div>
            <div class="popup-content">
                <h2>ãŠçŸ¥ã‚‰ã›</h2>
                <div id="notification-list">
                    </div>
                <button id="popupCloseButton">é–‰ã˜ã‚‹</button>
            </div>
        </div>
        <div class="container">
            <h1>PDCéå¯¾å¿œè¨ˆç®—ãƒ„ãƒ¼ãƒ«</h1>

            <div class="tabs">
                <button class="tab-button active" data-tab="damage">å‰²åˆè¨ˆç®—</button>
                <button class="tab-button" data-tab="exp">çµŒé¨“å€¤è¨ˆç®—</button>
                <button class="tab-button" data-tab="hp">HPè¨ˆç®—</button>
            </div>

            <div class="tab-content hidden" id="hp">
                <div class="hp-section">
                    <h3>1. ãƒ‘ãƒ¼ãƒ†ã‚£åˆè¨ˆHPè¨ˆç®—</h3>
                    <div class="input-group hp-party-inputs">
                        <label>å„ã‚­ãƒ£ãƒ©ã®HPã‚’å…¥åŠ›ï¼ˆ6ä½“åˆ†ï¼‰</label>
                        <div>
                            <input type="number" min="0" id="hp1" placeholder="1ä½“ç›® HP">
                            <input type="number" min="0" id="hp2" placeholder="2ä½“ç›® HP">
                            <input type="number" min="0" id="hp3" placeholder="3ä½“ç›® HP">
                            <input type="number" min="0" id="hp4" placeholder="4ä½“ç›® HP">
                            <input type="number" min="0" id="hp5" placeholder="5ä½“ç›® HP">
                            <input type="number" min="0" id="hp6" placeholder="6ä½“ç›® HP">
                        </div>
                        <button id="calcTotalHpBtn">åˆè¨ˆHPè¨ˆç®—</button>
                        <div class="hp-result" id="totalHpResult">-</div>
                    </div>
                </div>
                <div class="hp-section">
                    <h3>2. ãƒãƒ¼ãƒ HPè¦šé†’ã§ç››ã‚Œã¦ã„ã‚‹HP</h3>
                    <div class="input-group">
                        <label>åˆè¨ˆHP</label>
                        <input type="number" min="0" id="teamTotalHp" placeholder="åˆè¨ˆHP">
                        <label>ãƒãƒ¼ãƒ HPè¦šé†’ã®å€‹æ•°</label>
                        <input type="number" min="0" id="teamHpAwakeCount" placeholder="ãƒãƒ¼ãƒ HPè¦šé†’å€‹æ•°">
                        <button id="calcTeamHpAwakeBtn">ãƒãƒ¼ãƒ HPè¦šé†’ã§å¢—ãˆãŸHPè¨ˆç®—</button>
                        <div class="hp-result" id="teamHpAwakeResult">-</div>
                    </div>
                </div>
                <div class="hp-section">
                    <h3>3. å®Ÿè³ªHPè¨ˆç®—</h3>
                    <div class="input-group">
                        <label>åˆè¨ˆHP</label>
                        <input type="number" min="0" id="actualTotalHp" placeholder="åˆè¨ˆHP">
                        <label>ãƒªãƒ¼ãƒ€ãƒ¼HPå€ç‡</label>
                        <input type="number" min="0" step="0.01" id="leaderHpMulti" placeholder="ä¾‹: 2.6">
                        <label>è»½æ¸›ç‡ï¼ˆ0ã€œ1ï¼‰</label>
                        <input type="number" min="0" max="1" step="0.01" id="reduceRate" placeholder="ä¾‹: 0.5 (50%è»½æ¸›)">
                        <button id="calcActualHpBtn">å®Ÿè³ªHPè¨ˆç®—</button>
                        <div class="hp-result" id="actualHpResult">-</div>
                    </div>
                </div>
                <div class="hp-section">
                    <h3>4. ãƒãƒ¼ãƒ HPè¦šé†’å€‹æ•°é€†ç®—</h3>
                    <div class="input-group">
                        <label>ç›®æ¨™HP</label>
                        <input type="number" min="0" id="targetHp" placeholder="ç›®æ¨™HP">
                        <label>ç¾çŠ¶HP</label>
                        <input type="number" min="0" id="currentHp" placeholder="ç¾çŠ¶HP">
                        <button id="calcNeededAwakeBtn">å¿…è¦ãªãƒãƒ¼ãƒ HPè¦šé†’å€‹æ•°è¨ˆç®—</button>
                        <div class="hp-result" id="neededAwakeResult">-</div>
                    </div>
                </div>
            </div>
            <div class="tab-content" id="damage">
                <div class="input-group">
                    <label for="dungeonSelect">ãƒ€ãƒ³ã‚¸ãƒ§ãƒ³é¸æŠ:</label>
                    <select id="dungeonSelect"></select>
                </div>
                <div class="input-group">
                    <label for="floorSelect">ãƒ•ãƒ­ã‚¢é¸æŠ:</label>
                    <select id="floorSelect"></select>
                </div>
                <div class="input-group">
                    <label for="inputA">ãƒªãƒ¼ãƒ€ãƒ¼è»½æ¸›ç‡ (A) ä¾‹: 50%è»½æ¸›â†’0.5 , 20%è»½æ¸›â†’0.2</label>
                    <input id="inputA" max="1" min="0" step="0.01" type="number" value="0" />
                </div>
                <div class="input-group">
                    <label for="inputB">åŠ©ã£äººè»½æ¸›ç‡ (B) ä¾‹: 50%è»½æ¸›â†’0.5 , 20%è»½æ¸›â†’0.2</label>
                    <input id="inputB" max="1" min="0" step="0.01" type="number" value="0" />
                </div>
                <div class="input-group">
                    <label for="inputC">è»½æ¸›ã‚¹ã‚­ãƒ« (C)</label>
                    <select id="inputC">
                        <option value="0">0%</option>
                        <option value="0.05">5%</option>
                        <option value="0.1">10%</option>
                        <option value="0.15">15%</option>
                        <option value="0.2">20%</option>
                        <option value="0.25">25%</option>
                        <option value="0.3">30%</option>
                        <option value="0.35">35%</option>
                        <option value="0.4">40%</option>
                        <option value="0.45">45%</option>
                        <option value="0.5">50%</option>
                        <option value="0.6">60%</option>
                        <option value="0.65">65%</option>
                        <option value="0.7">70%</option>
                        <option value="0.75">75%</option>
                        <option value="0.8">80%</option>
                        <option value="0.85">85%</option>
                        <option value="0.9">90%</option>
                    <option value="1">100% (å®Œå…¨ç„¡åŠ¹)</option>
                </select>
                </div>
                <div class="input-group">
                    <label for="inputL">å›å¾©Lå­—æ¶ˆã—å€‹æ•° (1å€‹5%è»½æ¸›)</label>
                    <input id="inputL" min="0" step="1" type="number" value="0" />
                </div>
                <div id="results">
                    <h2>è¨ˆç®—çµæœ</h2>
                    <p id="totalReductionRate"></p>
                    <table class="results-table" id="resultsTable">
                        <thead>
                            <tr>
                                <th>ãƒ•ãƒ­ã‚¢ã®å‰²åˆãƒ€ãƒ¡ãƒ¼ã‚¸</th>
                                <th>æœ€çµ‚çš„ãªHPã«å¯¾ã™ã‚‹ãƒ€ãƒ¡ãƒ¼ã‚¸å‰²åˆ</th>
                                <th>è€ãˆã‚Œã‚‹ã‹</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div class="tab-content hidden" id="exp">
                <div class="input-group">
                    <label for="expDungeon">ãƒ€ãƒ³ã‚¸ãƒ§ãƒ³é¸æŠ:</label>
                    <select id="expDungeon"></select>
                </div>
                <div class="input-group">
                    <label for="expFloor">ãƒ•ãƒ­ã‚¢é¸æŠ:</label>
                    <select disabled="" id="expFloor"></select>
                </div>
                <div class="input-group">
                    <label for="leaderMultiplier">ãƒªãƒ¼ãƒ€ãƒ¼çµŒé¨“å€¤å€ç‡:</label>
                    <select id="leaderMultiplier">
                        <option value="1.0">1.0å€</option>
                        <option value="1.1">1.1å€</option>
                        <option value="1.2">1.2å€</option>
                        <option value="1.3">1.3å€</option>
                        <option value="1.4">1.4å€</option>
                        <option value="1.5">1.5å€</option>
                        <option value="1.6">1.6å€</option>
                        <option value="1.7">1.7å€</option>
                        <option value="1.8">1.8å€</option>
                        <option value="1.9">1.9å€</option>
                        <option value="2.0">2.0å€</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="friendMultiplier">åŠ©ã£äººçµŒé¨“å€¤å€ç‡:</label>
                    <select id="friendMultiplier">
                        <option value="1.0">1.0å€</option>
                        <option value="1.1">1.1å€</option>
                        <option value="1.2">1.2å€</option>
                        <option value="1.3">1.3å€</option>
                        <option value="1.4">1.4å€</option>
                        <option value="1.5">1.5å€</option>
                        <option value="1.6">1.6å€</option>
                        <option value="1.7">1.7å€</option>
                        <option value="1.8">1.8å€</option>
                        <option value="1.9">1.9å€</option>
                        <option value="2.0">2.0å€</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="dungeonBonusCount">ãƒ€ãƒ³ã‚¸ãƒ§ãƒ³ãƒœãƒ¼ãƒŠã‚¹è¦šé†’æ•°:</label>
                    <input id="dungeonBonusCount" min="0" step="1" type="number" value="0" />
                    <small>1ã¤ã«ã¤ã2%åŠ ç®—ã•ã‚Œã€ç´¯ä¹—ã•ã‚Œã¾ã™</small>
                </div>
                <div id="expResult">
                    <h2>çµŒé¨“å€¤çµæœ</h2>
                    <p id="expValue">-</p>
                </div>
            </div>
        </div>

        <script>
            // ----------- ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿é–¢é€£ -----------
            async function fetchDamageDungeonData() {
                const response = await fetch('./dungeonData.json');
                if (!response.ok) {
                    alert('ãƒ€ãƒ¡ãƒ¼ã‚¸ãƒ€ãƒ³ã‚¸ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                    return {};
                }
                const data = await response.json();
                for (const dungeon in data) {
                    for (const floor in data[dungeon]) {
                        if (typeof data[dungeon][floor] === 'string') {
                            data[dungeon][floor] = data[dungeon][floor]
                                .split(',')
                                .map(s => parseFloat(s.replace('%', '').trim()))
                                .filter(v => !isNaN(v));
                        }
                    }
                }
                return data;
            }

            async function fetchExpData() {
                const response = await fetch('./pad_experience_data.json');
                if (!response.ok) {
                    alert('çµŒé¨“å€¤ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                    return {};
                }
                const data = await response.json();
                return data;
            }

            // ----------- HTMLè¦ç´ å–å¾— -----------
            const dungeonSelect = document.getElementById('dungeonSelect');
            const floorSelect = document.getElementById('floorSelect');
            const inputA = document.getElementById('inputA');
            const inputB = document.getElementById('inputB');
            const inputC = document.getElementById('inputC');
            const inputL = document.getElementById('inputL');
            const totalReductionRateDisplay = document.getElementById('totalReductionRate');
            const resultsTableBody = document.querySelector('#resultsTable tbody');

            const expDungeon = document.getElementById('expDungeon');
            const expFloor = document.getElementById('expFloor');
            const leaderMultiplier = document.getElementById('leaderMultiplier');
            const friendMultiplier = document.getElementById('friendMultiplier');
            const dungeonBonusCount = document.getElementById('dungeonBonusCount');
            const expValueDisplay = document.getElementById('expValue');

            const tabs = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');

            let damageDungeonData = {};
            let expData = {};

            // ----------- ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆå‡¦ç† -----------

            // ã‚¿ãƒ–ã”ã¨ã«åˆæœŸåŒ–é–¢æ•°ã‚’ç”¨æ„
            let damageTabInitialized = false;
            let expTabInitialized = false;
            let hpTabInitialized = false;

            function setupDamageTab() {
                if (damageTabInitialized) return;
                floorSelect.addEventListener('change', runDamageCalculation);
                [inputA, inputB, inputC, inputL].forEach(el => {
                    el.addEventListener('input', runDamageCalculation);
                    el.addEventListener('change', runDamageCalculation);
                });
                damageTabInitialized = true;
            }

            function setupExpTab() {
                if (expTabInitialized) return;
                expFloor.addEventListener('change', calculateExp);
                leaderMultiplier.addEventListener('change', calculateExp);
                friendMultiplier.addEventListener('change', calculateExp);
                dungeonBonusCount.addEventListener('input', calculateExp);
                expTabInitialized = true;
            }

            function setupHpTab() {
                if (hpTabInitialized) return;
                document.getElementById('calcTotalHpBtn').addEventListener('click', () => {
                    const hps = [1,2,3,4,5,6].map(i => parseInt(document.getElementById('hp'+i).value) || 0);
                    const total = hps.reduce((a,b) => a+b, 0);
                    document.getElementById('totalHpResult').textContent = `åˆè¨ˆHP: ${total.toLocaleString()}`;
                });
                document.getElementById('calcTeamHpAwakeBtn').addEventListener('click', () => {
                    const totalHp = parseInt(document.getElementById('teamTotalHp').value) || 0;
                    const count = parseInt(document.getElementById('teamHpAwakeCount').value) || 0;
                    const plus = Math.floor(totalHp / (1 + 0.05 * count) * 0.05 * count);
                    document.getElementById('teamHpAwakeResult').textContent = `ãƒãƒ¼ãƒ HPè¦šé†’ã§å¢—ãˆãŸHP: ${plus.toLocaleString()}`;
                });
                document.getElementById('calcActualHpBtn').addEventListener('click', () => {
                    const totalHp = parseInt(document.getElementById('actualTotalHp').value) || 0;
                    const multi = parseFloat(document.getElementById('leaderHpMulti').value) || 1;
                    const reduce = parseFloat(document.getElementById('reduceRate').value) || 0;
                    if(reduce >= 1) {
                        document.getElementById('actualHpResult').textContent = 'è»½æ¸›ç‡ã¯1æœªæº€ã§å…¥åŠ›ã—ã¦ãã ã•ã„';
                        return;
                    }
                    const actual = totalHp * multi / (1 - reduce);
                    document.getElementById('actualHpResult').textContent = `å®Ÿè³ªHP: ${Math.round(actual).toLocaleString()}ï¼ˆå€ç‡Ã—1/(1-è»½æ¸›ç‡)ï¼‰`;
                });
                document.getElementById('calcNeededAwakeBtn').addEventListener('click', () => {
                    const target = parseInt(document.getElementById('targetHp').value) || 0;
                    const current = parseInt(document.getElementById('currentHp').value) || 0;
                    if(current <= 0) {
                        document.getElementById('neededAwakeResult').textContent = 'ç¾çŠ¶HPã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„';
                        return;
                    }
                    let n = 0;
                    let hp = current;
                    while(hp < target && n < 99) {
                        n++;
                        hp = Math.floor(current * (1 + 0.05 * n));
                    }
                    if(hp < target) {
                        document.getElementById('neededAwakeResult').textContent = '99å€‹ã§ã‚‚åˆ°é”ã§ãã¾ã›ã‚“';
                    } else {
                        document.getElementById('neededAwakeResult').textContent = `ã‚ã¨${n}å€‹å¿…è¦ã§ã™ï¼ˆåˆè¨ˆHP: ${hp.toLocaleString()}ï¼‰`;
                    }
                });
                hpTabInitialized = true;
            }

            // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆæ™‚ã«è©²å½“ã‚¿ãƒ–ã®åˆæœŸåŒ–é–¢æ•°ã‚’å‘¼ã¶
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    tabContents.forEach(tc => {
                        if (tc.id === tab.dataset.tab) {
                            tc.classList.remove('hidden');
                        } else {
                            tc.classList.add('hidden');
                        }
                    });
                    if(tab.dataset.tab === 'damage') setupDamageTab();
                    if(tab.dataset.tab === 'exp') setupExpTab();
                    if(tab.dataset.tab === 'hp') setupHpTab();
                });
            });

            // åˆæœŸè¡¨ç¤ºæ™‚ã«damageã‚¿ãƒ–ã ã‘ã§ãªãã€activeãªã‚¿ãƒ–ã®åˆæœŸåŒ–ã‚‚è¡Œã†
            const activeTab = document.querySelector('.tab-button.active');
            if (activeTab) {
                if(activeTab.dataset.tab === 'damage') setupDamageTab();
                if(activeTab.dataset.tab === 'exp') setupExpTab();
                if(activeTab.dataset.tab === 'hp') setupHpTab();
                tabContents.forEach(tc => {
                    if (tc.id === activeTab.dataset.tab) {
                        tc.classList.remove('hidden');
                    } else {
                        tc.classList.add('hidden');
                    }
                });
            }

            // ----------- ãƒ€ãƒ¡ãƒ¼ã‚¸è»½æ¸›å‡¦ç† -----------
            function initializeDamageDungeonSelect() {
                dungeonSelect.innerHTML = '<option value="">ãƒ€ãƒ³ã‚¸ãƒ§ãƒ³ã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
                for (const dungeonName in damageDungeonData) {
                    const option = document.createElement('option');
                    option.value = dungeonName;
                    option.textContent = dungeonName;
                    dungeonSelect.appendChild(option);
                }
                floorSelect.innerHTML = '<option value="">ãƒ•ãƒ­ã‚¢ã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
                floorSelect.disabled = true;
            }

            dungeonSelect.addEventListener('change', () => {
                const selectedDungeon = dungeonSelect.value;
                floorSelect.innerHTML = '<option value="">ãƒ•ãƒ­ã‚¢ã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
                floorSelect.disabled = true;

                if (selectedDungeon && damageDungeonData[selectedDungeon]) {
                    const floors = damageDungeonData[selectedDungeon];
                    for (const floorName in floors) {
                        const option = document.createElement('option');
                        option.value = floorName;
                        option.textContent = floorName;
                        floorSelect.appendChild(option);
                    }
                    floorSelect.disabled = false;
                }
                runDamageCalculation();
            });

            floorSelect.addEventListener('change', runDamageCalculation);
            [inputA, inputB, inputC, inputL].forEach(el => {
                el.addEventListener('input', runDamageCalculation);
                el.addEventListener('change', runDamageCalculation);
            });

            function runDamageCalculation() {
                const selectedDungeon = dungeonSelect.value;
                const selectedFloor = floorSelect.value;
                const valA = parseFloat(inputA.value);
                const valB = parseFloat(inputB.value);
                const valC = parseFloat(inputC.value);
                const valL = parseInt(inputL.value) || 0;

                resultsTableBody.innerHTML = '';

                if (!selectedDungeon || !selectedFloor) {
                    totalReductionRateDisplay.textContent = '';
                    if (selectedDungeon && selectedFloor && damageDungeonData[selectedDungeon]?.[selectedFloor]) {
                        const damageRatios = damageDungeonData[selectedDungeon][selectedFloor];
                        damageRatios.forEach(ratio => {
                            const tr = document.createElement('tr');
                            tr.innerHTML = `<td>${ratio}%</td><td>${ratio}%</td><td>-</td>`;
                            resultsTableBody.appendChild(tr);
                        });
                    }
                    return;
                }

                if (isNaN(valA) || isNaN(valB)) {
                    totalReductionRateDisplay.textContent = 'ãƒªãƒ¼ãƒ€ãƒ¼è»½æ¸›ç‡ã¨åŠ©ã£äººè»½æ¸›ç‡ã¯æ•°å€¤ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
                    return;
                }

                if (valL < 0) {
                    totalReductionRateDisplay.textContent = 'å€‹æ•°ã¯0ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
                    return;
                }
                
                // ===== â–¼â–¼â–¼ã€ä»Šåº¦ã“ãã€ã”æŒ‡å®šã®æ­£ã—ã„ãƒ­ã‚¸ãƒƒã‚¯ã§ã™ã€‘â–¼â–¼â–¼
                // è»½æ¸›ç‡è¨ˆç®—
                // (1 - A) * (1 - B) * (1 - C) * (1 - 0.05 * L)
                const leaderReduce = 1 - valA;
                const friendReduce = 1 - valB;
                const skillReduce = 1 - valC;
                const lReduce = 1 - 0.05 * valL;

                let totalReduce = leaderReduce * friendReduce * skillReduce * lReduce;
                totalReduce = Math.max(0, Math.min(1, totalReduce)); // 0ã€œ1ã«åˆ¶é™
                const totalReducePercent = ((1 - totalReduce) * 100).toFixed(2);
                totalReductionRateDisplay.textContent = `ç·è»½æ¸›ç‡: ${totalReducePercent}%`;


                // ãƒ€ãƒ¡ãƒ¼ã‚¸è»½æ¸›å¾Œã®ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                const damageRatios = damageDungeonData[selectedDungeon][selectedFloor];

                damageRatios.forEach(ratio => {

                    // ratio ã¯å…ƒã®ãƒ€ãƒ¡ãƒ¼ã‚¸å‰²åˆï¼ˆä¾‹ï¼š100%ï¼‰
                    // totalReduce ã¯ã€Œæ®‹ã‚Šãƒ€ãƒ¡ãƒ¼ã‚¸å€ç‡ã€ãªã®ã§ã€ratio * totalReduce ãŒæ­£ã—ã„
                    const finalDamagePercent = (ratio * totalReduce).toFixed(2);
                    const canSurvive = finalDamagePercent < 100 ? 'è€ãˆã‚‰ã‚Œã‚‹' : 'è€ãˆã‚‰ã‚Œãªã„';

                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${ratio}%</td>
                        <td>${finalDamagePercent}%</td>
                        <td class="${canSurvive === 'è€ãˆã‚‰ã‚Œã‚‹' ? 'can-withstand' : 'cannot-withstand'}">${canSurvive}</td>
                        `;
                    resultsTableBody.appendChild(tr);
                });
                // ===== â–²â–²â–²ã€ã“ã“ã¾ã§ãŒä¿®æ­£ç®‡æ‰€ã§ã™ã€‘â–²â–²â–²
            }


            // ----------- çµŒé¨“å€¤è¨ˆç®—å‡¦ç† -----------
            function initializeExpDungeonSelect() {
                expDungeon.innerHTML = '<option value="">ãƒ€ãƒ³ã‚¸ãƒ§ãƒ³ã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
                for (const dungeonName in expData) {
                    const option = document.createElement('option');
                    option.value = dungeonName;
                    option.textContent = dungeonName;
                    expDungeon.appendChild(option);
                }
                expFloor.innerHTML = '<option value="">ãƒ•ãƒ­ã‚¢ã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
                expFloor.disabled = true;
            }

            expDungeon.addEventListener('change', () => {
                const dungeonName = expDungeon.value;
                expFloor.innerHTML = '<option value="">ãƒ•ãƒ­ã‚¢ã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
                expFloor.disabled = true;
                expValueDisplay.textContent = '-';

                if (!dungeonName) return;
                const floors = expData[dungeonName];
                if (floors && typeof floors === 'object' && !Array.isArray(floors)) {
                    for (const floorName in floors) {
                        const option = document.createElement('option');
                        option.value = floorName;
                        option.textContent = floorName;
                        expFloor.appendChild(option);
                    }
                    expFloor.disabled = false;
                } else {
                    expFloor.disabled = true;
                }
                calculateExp();
            });

            expFloor.addEventListener('change', calculateExp);
            leaderMultiplier.addEventListener('change', calculateExp);
            friendMultiplier.addEventListener('change', calculateExp);
            dungeonBonusCount.addEventListener('input', calculateExp);

            function calculateExp() {
                const dungeonName = expDungeon.value;
                const floorName = expFloor.value;
                if (!dungeonName) { expValueDisplay.textContent = '-'; return; }
                const floors = expData[dungeonName];
                let baseExp;
                if (typeof floors === 'object' && !Array.isArray(floors)) {
                    if (!floorName) { expValueDisplay.textContent = '-'; return; }
                    baseExp = floors[floorName];
                } else {
                    baseExp = floors;
                }
                if (typeof baseExp === 'undefined') { expValueDisplay.textContent = '-'; return; }
                const leaderMulti = parseFloat(leaderMultiplier.value);
                const friendMulti = parseFloat(friendMultiplier.value);
                const bonusCount = parseInt(dungeonBonusCount.value) || 0;
                const bonusMultiplier = Math.pow(1.02, bonusCount);
                const totalExp = baseExp * leaderMulti * friendMulti * bonusMultiplier;
                expValueDisplay.textContent = `ç²å¾—çµŒé¨“å€¤: ${Math.round(totalExp).toLocaleString()}`;
            }

            // ----------- ãŠçŸ¥ã‚‰ã›æ©Ÿèƒ½é–¢é€£ -----------
            const notificationIcon = document.getElementById('notificationIcon');
            const notificationBadge = document.getElementById('notificationBadge');
            const notificationPopup = document.getElementById('notificationPopup');
            const popupOverlay = document.getElementById('popupOverlay');
            const popupCloseButton = document.getElementById('popupCloseButton');
            const notificationList = document.getElementById('notification-list');
            
            let latestNotificationDate = ''; // æœ€æ–°ã®ãŠçŸ¥ã‚‰ã›ã®æ—¥ä»˜ã‚’ä¿æŒã™ã‚‹å¤‰æ•°

            async function fetchAndShowNotifications() {
            // ãƒ‡ãƒ¼ã‚¿åŒæœŸãƒœã‚¿ãƒ³
            const syncButton = document.getElementById('syncButton');
            if (syncButton) {
                syncButton.addEventListener('click', async () => {
                    syncButton.disabled = true;
                    syncButton.textContent = 'åŒæœŸä¸­...';
                    try {
                        await initializeAll();
                        syncButton.textContent = 'æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã«æ›´æ–°ã—ã¾ã—ãŸ';
                        setTimeout(() => {
                            syncButton.textContent = 'ãƒ‡ãƒ¼ã‚¿åŒæœŸ';
                            syncButton.disabled = false;
                        }, 1500);
                    } catch (e) {
                        syncButton.textContent = 'åŒæœŸå¤±æ•—';
                        setTimeout(() => {
                            syncButton.textContent = 'ãƒ‡ãƒ¼ã‚¿åŒæœŸ';
                            syncButton.disabled = false;
                        }, 2000);
                    }
                });
            }
                try {
                    const response = await fetch(`./announcements.json?t=${new Date().getTime()}`);
                    if (!response.ok) throw new Error('ãŠçŸ¥ã‚‰ã›ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—');
                    
                    const notifications = await response.json();
                    notificationList.innerHTML = '';

                    if (notifications && notifications.length > 0) {
                        // ãŠçŸ¥ã‚‰ã›ãŒæ—¥ä»˜é †ã«ã‚½ãƒ¼ãƒˆã•ã‚Œã¦ã„ã‚‹ã¨ä»®å®šã—ã€æœ€æ–°ã®æ—¥ä»˜ã‚’å–å¾—
                        latestNotificationDate = notifications[0].date;
                        
                        // ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰æœ€å¾Œã«èª­ã‚“ã ãŠçŸ¥ã‚‰ã›ã®æ—¥ä»˜ã‚’å–å¾—
                        const lastReadDate = localStorage.getItem('lastReadNotificationDate');
                        let unreadCount = 0;

                        notifications.forEach(item => {
                            const div = document.createElement('div');
                            div.className = 'notification-item';
                            div.innerHTML = `<strong>${item.date}</strong><p>${item.content}</p>`;
                            notificationList.appendChild(div);

                            // æœªèª­ã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯
                            if (!lastReadDate || item.date > lastReadDate) {
                                unreadCount++;
                            }
                        });

                        // æœªèª­ä»¶æ•°ã«å¿œã˜ã¦ãƒãƒƒã‚¸ã‚’æ›´æ–°
                        if (unreadCount > 0) {
                            notificationBadge.textContent = unreadCount;
                            notificationBadge.classList.remove('hidden');
                            notificationIcon.classList.add('active');
                        } else {
                            notificationBadge.classList.add('hidden');
                            notificationIcon.classList.remove('active');
                        }

                    } else {
                        notificationList.innerHTML = '<p>æ–°ã—ã„ãŠçŸ¥ã‚‰ã›ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
                        notificationBadge.classList.add('hidden');
                        notificationIcon.classList.remove('active');
                    }
                } catch (error) {
                    console.error('ãŠçŸ¥ã‚‰ã›æ©Ÿèƒ½ã‚¨ãƒ©ãƒ¼:', error);
                    notificationList.innerHTML = '<p>ãŠçŸ¥ã‚‰ã›ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>';
                }
            }

            notificationIcon.addEventListener('click', () => {
                notificationPopup.classList.remove('hidden');
                notificationBadge.classList.add('hidden'); // ãƒãƒƒã‚¸ã‚’éè¡¨ç¤ºã«
                notificationIcon.classList.remove('active'); // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’åœæ­¢

                // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’é–‹ã„ãŸæ™‚ç‚¹ã§ã€æœ€æ–°ã®ãŠçŸ¥ã‚‰ã›ã‚’ã€Œæ—¢èª­ã€ã¨ã—ã¦è¨˜éŒ²
                if (latestNotificationDate) {
                    localStorage.setItem('lastReadNotificationDate', latestNotificationDate);
                }
            });

            popupOverlay.addEventListener('click', () => notificationPopup.classList.add('hidden'));
            popupCloseButton.addEventListener('click', () => popupCloseButton.parentElement.parentElement.classList.add('hidden'));
            
            // ----------- PWA ã¨ åˆæœŸåŒ–å‡¦ç† -----------
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => console.log('Service Worker: ç™»éŒ²æˆåŠŸ', registration))
                    .catch(error => console.error('Service Worker: ç™»éŒ²å¤±æ•—', error));
            }

            async function initializeAll() {
                damageDungeonData = await fetchDamageDungeonData();
                expData = await fetchExpData();
                
                initializeDamageDungeonSelect();
                initializeExpDungeonSelect();
                
                runDamageCalculation();
                calculateExp();
                
                fetchAndShowNotifications();
            }

            initializeAll();
        </script>
    </body>
</html>
